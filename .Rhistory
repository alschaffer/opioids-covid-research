cbind(sum(opioid_any), "Any"),
cbind(sum(hi_opioid_any), "High dose")
)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose")
)
View(admin)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose"),
cbind(sum(for_tables$long_opioid_any), "Long acting"),
cbind(sum(for_tables$oral_opioid_any), "Oral"),
cbind(sum(for_tables$par_opioid_any), "Parenteral"),
cbind(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(sum(for_tables$buc_opioid_any), "Buccal"),
cbind(sum(for_tables$inh_opioid_any), "Inhaled"),
cbind(sum(for_tables$rec_opioid_any), "Rectal")
) %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = length(for_tables),
prevalence_per_1000 = no_people/ tot * 1000)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose"),
cbind(sum(for_tables$long_opioid_any), "Long acting"),
cbind(sum(for_tables$oral_opioid_any), "Oral"),
cbind(sum(for_tables$par_opioid_any), "Parenteral"),
cbind(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(sum(for_tables$buc_opioid_any), "Buccal"),
cbind(sum(for_tables$inh_opioid_any), "Inhaled"),
cbind(sum(for_tables$rec_opioid_any), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = length(for_tables),
prevalence_per_1000 = no_people/ tot * 1000)
View(admin)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose"),
cbind(sum(for_tables$long_opioid_any), "Long acting"),
cbind(sum(for_tables$oral_opioid_any), "Oral"),
cbind(sum(for_tables$par_opioid_any), "Parenteral"),
cbind(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(sum(for_tables$buc_opioid_any), "Buccal"),
cbind(sum(for_tables$inh_opioid_any), "Inhaled"),
cbind(sum(for_tables$rec_opioid_any), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables)),
prevalence_per_1000 = no_people/ tot * 1000)
is.numeric(admin$V1)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose"),
cbind(sum(for_tables$long_opioid_any), "Long acting"),
cbind(sum(for_tables$oral_opioid_any), "Oral"),
cbind(sum(for_tables$par_opioid_any), "Parenteral"),
cbind(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(sum(for_tables$buc_opioid_any), "Buccal"),
cbind(sum(for_tables$inh_opioid_any), "Inhaled"),
cbind(sum(for_tables$rec_opioid_any), "Rectal")
) %>%
as.data.frame()
is.numeric(admin$V1)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables)),
prevalence_per_1000 = no_people/ tot * 1000)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables)),
prevalence_per_1000 = no_people/ tot * 1000)
admin <- rbind(
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables)),
prevalence_per_1000 = no_people/ tot * 1000)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables))) %>%
mutate( prevalence_per_1000 = no_people/tot*1000)
min route
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(length(for_tables)))
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(n(for_tables)))
length(for_tables)
n(for_tables)
count(for_tables)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(count(for_tables))) %>%
mutate( prevalence_per_1000 = no_people/tot*1000)
admin <- rbind(
cbind(as.numeric(sum(for_tables$opioid_any)), "Any"),
cbind(as.numeric(sum(for_tables$hi_opioid_any)), "High dose"),
cbind(as.numeric(sum(for_tables$long_opioid_any)), "Long acting"),
cbind(as.numeric(sum(for_tables$oral_opioid_any)), "Oral"),
cbind(as.numeric(sum(for_tables$par_opioid_any)), "Parenteral"),
cbind(as.numeric(sum(for_tables$trans_opioid_any)), "Transdermal"),
cbind(as.numeric(sum(for_tables$buc_opioid_any)), "Buccal"),
cbind(as.numeric(sum(for_tables$inh_opioid_any)), "Inhaled"),
cbind(as.numeric(sum(for_tables$rec_opioid_any)), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(tot = as.numeric(count(for_tables)))
is.numeric(admin$no_people)
admin <- rbind(
cbind(sum(for_tables$opioid_any), "Any"),
cbind(sum(for_tables$hi_opioid_any), "High dose"),
cbind(sum(for_tables$long_opioid_any), "Long acting"),
cbind(sum(for_tables$oral_opioid_any), "Oral"),
cbind(sum(for_tables$par_opioid_any), "Parenteral"),
cbind(sum(for_tables$trans_opioid_any), "Transdermal"),
cbind(sum(for_tables$buc_opioid_any), "Buccal"),
cbind(sum(for_tables$inh_opioid_any), "Inhaled"),
cbind(sum(for_tables$rec_opioid_any), "Rectal")
) %>%
as.data.frame() %>%
rename(no_people = V1, formulation = V2) %>%
mutate(no_people = as.numeric(no_people),
tot = as.numeric(count(for_tables))) %>%
mutate( prevalence_per_1000 = no_people/tot*1000)
##### Read in data #######
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
View(combined)
## Create directories
dir_create(here::here("output", "released_outputs"), showWarnings = FALSE, recurse = TRUE)
## Read in data and create working datasets
# Prevalent prescribing
prev_full <- read_csv(here::here("output", "released_outputs", "ts_prev_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# New prescribing
new_full <- read_csv(here::here("output", "released_outputs", "ts_new_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# Combine and save
combined <- merge(prev_full, new_full, by = c("group", "label", "date", "period"))
# Create variable for proportion of opioid users are newly prescribed opioids
combined$pcent_new <- combined$new_opioid_prescribing/combined$any_opioid_prescribing*100
combined$pcent_hi <- combined$any_high_dose_opioid_prescribing/combined$any_opioid_prescribing*100
write.csv(combined, file = here::here("output", "released_outputs", "ts_combined_full.csv"),
row.names = FALSE)
##########################
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
## Create variables to estimate change during
##    lockdown and recovery periods
data1 <- ts(subset(combined, group == "Total")$prevalence_per_1000,
start = c(2018,01,01), frequency = 12)
its.vars <- data.frame(
time = seq(1,length(data1)),
step = append(rep(0,26),rep(1,25)),
slope = append(rep(0,26),seq(1,25)),
slope2 = append(rep(0,39),seq(1,12)),
step2 = append(rep(0,39), rep(1,12)),
month = season(data1),
mar20 = append(append(rep(0,26),1),rep(0,24)),
apr20 = append(append(rep(0,27),1),rep(0,23)),
may20 = append(append(rep(0,28),1),rep(0,22))
)
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(combined, rep(its.vars, length(combined)/length(its.vars)))
View(combined.its)
write.csv(combined.its, file = here::here("output", "released_outputs", "ts_combined_full.csv"),
row.names = FALSE)
##### Read in data #######
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
View(combined)
## Create directories
dir_create(here::here("output", "released_outputs"), showWarnings = FALSE, recurse = TRUE)
## Read in data and create working datasets
# Prevalent prescribing
prev_full <- read_csv(here::here("output", "released_outputs", "ts_prev_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# New prescribing
new_full <- read_csv(here::here("output", "released_outputs", "ts_new_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# Combine and save
combined <- merge(prev_full, new_full, by = c("group", "label", "date", "period"))
# Create variable for proportion of opioid users are newly prescribed opioids
combined$pcent_new <- combined$new_opioid_prescribing/combined$any_opioid_prescribing*100
combined$pcent_hi <- combined$any_high_dose_opioid_prescribing/combined$any_opioid_prescribing*100
write.csv(combined, file = here::here("output", "released_outputs", "ts_combined_full.csv"),
row.names = FALSE)
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
## Create variables to estimate change during
##    lockdown and recovery periods
data1 <- ts(subset(combined, group == "Total")$prevalence_per_1000,
start = c(2018,01,01), frequency = 12)
its.vars <- data.frame(
time = seq(1,length(data1)),
step = append(rep(0,26),rep(1,25)),
slope = append(rep(0,26),seq(1,25)),
slope2 = append(rep(0,39),seq(1,12)),
step2 = append(rep(0,39), rep(1,12)),
month = season(data1),
mar20 = append(append(rep(0,26),1),rep(0,24)),
apr20 = append(append(rep(0,27),1),rep(0,23)),
may20 = append(append(rep(0,28),1),rep(0,22))
)
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(combined, rep(its.vars, length(combined)/length(its.vars)))
View(combined.its)
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(combined, rep(its.vars, count(combined)/combined(its.vars)))
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(combined, rep(its.vars, count(combined)/count(its.vars)))
## Read in data
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
length
View(combined)
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(rep(its.vars, count(combined)/count(its.vars)))
View(combined.its)
## Create directories
dir_create(here::here("output", "released_outputs"), showWarnings = FALSE, recurse = TRUE)
## Read in data and create working datasets
# Prevalent prescribing
prev_full <- read_csv(here::here("output", "released_outputs", "ts_prev_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# New prescribing
new_full <- read_csv(here::here("output", "released_outputs", "ts_new_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d"))) %>%
mutate(period = ifelse(date < as.Date("2020-03-01"), "Pre-COVID",
ifelse(date >= as.Date("2021-04-01"), "Recovery", "Lockdown")))
# Combine and save
combined <- merge(prev_full, new_full, by = c("group", "label", "date", "period"))
# Create variable for proportion of opioid users are newly prescribed opioids
combined$pcent_new <- combined$new_opioid_prescribing/combined$any_opioid_prescribing*100
combined$pcent_hi <- combined$any_high_dose_opioid_prescribing/combined$any_opioid_prescribing*100
write.csv(combined, file = here::here("output", "released_outputs", "ts_combined_full.csv"),
row.names = FALSE)
2040/51
combined.its <- combined  %>% arrange(group, label, date) %>%
cbind(rep(its.vars, 40))
its.vars2 <- rep(its.vars, 40)
View(its.vars2)
combined.its <- combined  %>% arrange(group, label, date) %>%
mutate(time = seq(1,51),
step = ifelse(date < as.Date("2020-03-01"), 0, 1),
step2 = ifelse(date < as.Date("2021-04-01"), 0, 1),
month = season(data1),
mar20 = ifelse(date == as.Date("2020-03-01"), 1, 0),
apr20 = ifelse(date == as.Date("2020-04-01"), 1, 0),
may20 = ifelse(date == as.Date("2020-05-01"), 1, 0))
combined.its <- combined  %>% arrange(group, label, date) %>%
mutate(time = rep(seq(1,51), 40),
step = ifelse(date < as.Date("2020-03-01"), 0, 1),
step2 = ifelse(date < as.Date("2021-04-01"), 0, 1),
month = season(data1),
mar20 = ifelse(date == as.Date("2020-03-01"), 1, 0),
apr20 = ifelse(date == as.Date("2020-04-01"), 1, 0),
may20 = ifelse(date == as.Date("2020-05-01"), 1, 0))
combined.its <- combined  %>% arrange(group, label, date) %>%
mutate(time = rep(seq(1,51), 40),
step = ifelse(date < as.Date("2020-03-01"), 0, 1),
step2 = ifelse(date < as.Date("2021-04-01"), 0, 1),
month = season(date),
mar20 = ifelse(date == as.Date("2020-03-01"), 1, 0),
apr20 = ifelse(date == as.Date("2020-04-01"), 1, 0),
may20 = ifelse(date == as.Date("2020-05-01"), 1, 0))
combined.its <-
cbind(combined, rep(its.vars, 40))
View(combined.its)
its.vars40 <- rep(its.vars , 40)
its.vars40 <- rep(1:nrow(its.vars),40),]
its.vars40 <- rep(1:nrow(its.vars),40)
combined.its <- combined %>% arrange(group, label, date) %>%
cbind(rep(1:nrow(its.vars),40))
View(combined.its)
combined.its <-
cbind(combined, rep(1:nrow(its.vars),40))
its.vars40 <- its.vars[rep(1:nrow(its.vars),40),]
View(its.vars40)
combined.its <- combined %>% arrange(group, label, date) %>%
cbind(its.vars40)
write.csv(combined.its, file = here::here("output", "released_outputs", "ts_combined_full.csv"),
row.names = FALSE)
##### Read in data #######
combined <- read_csv(here::here("output", "released_outputs", "ts_combined_full.csv"),
col_types = cols(
group  = col_character(),
label = col_character(),
date = col_date(format="%Y-%m-%d")))
nb <- function(data, ref){
data$label <- relevel(as.factor(data$label), ref = ref)
mod1 <- glm.nb(any_opioid_prescribing ~ time + step*label  + step2*label + slope + slope2 +
mar20 + apr20 + may20 +
month + offset(log(total_population)), data= data, link = "log",
control = list(trace = TRUE, maxiter = 30, epsilon = 1))
ci1 <- coefci(mod1, vcov. = vcovPL(mod1, cluster = data$label)) %>% exp()
coef1 <- mod1$coefficients  %>% exp()
coef1 <- data.frame(ci1, coef = coef1, label = rownames(ci1)) %>%
clean_names() %>% subset(label %in% c("step", "step2"))
coef <- coef1 %>%
mutate(
coef = as.numeric(coef),
x2_5 = as.numeric(x2_5),
x97_5 = as.numeric(x97_5),
time = ifelse(label == "step", "Lockdown", "Recovery"),
label = ref)
return(coef)
}
nb_inc <- function(data, ref){
data$label <- relevel(as.factor(data$label), ref = ref)
mod1 <- glm.nb(new_opioid_prescribing ~ time + step*label  + step2*label + slope + slope2 +
month + offset(log(opioid_naive)), data= data, link = "log")
ci1 <- coefci(mod1, vcov. = vcovPL(mod1, cluster = data$label)) %>% exp()
coef1 <- mod1$coefficients  %>% exp()
coef1 <- data.frame(ci1, coef = coef1, label = rownames(ci1)) %>%
clean_names() %>% subset(label %in% c("step", "step2"))
coef <- coef1 %>%
mutate(
coef = as.numeric(coef),
x2_5 = as.numeric(x2_5),
x97_5 = as.numeric(x97_5),
time = ifelse(label == "step", "Lockdown", "Recovery"),
label = ref)
return(coef)
}
pred_val <- function(data){
mod1 <- glm.nb(any_opioid_prescribing ~ time + mar20 + step*label  + step2*label +
slope + slope2 + apr20 + may20 + month + offset(log(total_population)),
data = data, link = "log",
control = list(trace = TRUE, maxiter = 30, epsilon = 1))
pred <- predict(mod1, se.fit = TRUE)
pred2 <-
data.frame(pred_n = exp(pred$fit), lci_n = exp(pred$fit-1.96*pred$se.fit),
uci_n = exp(pred$fit+1.96*pred$se.fit), data) %>%
mutate(pred = pred_n/total_population*1000, pred_lci = lci_n/total_population*1000,
pred_uci = uci_n/total_population*1000)
return(pred2)
}
nb_hi <- function(data, ref){
data$label <- relevel(as.factor(data$label), ref = ref)
mod1 <- glm.nb(any_high_dose_opioid_prescribing ~
time + step*label  + step2*label + slope + slope2 +
mar20 + apr20 + may20 +
month + offset(log(total_population)), data= data, link = "log",
control = list(trace = TRUE, maxiter = 30, epsilon = 1))
ci1 <- coefci(mod1, vcov. = vcovPL(mod1, cluster = data$label)) %>% exp()
coef1 <- mod1$coefficients  %>% exp()
coef1 <- data.frame(ci1, coef = coef1, label = rownames(ci1)) %>%
clean_names() %>% subset(label %in% c("step", "step2"))
coef <- coef1 %>%
mutate(
coef = as.numeric(coef),
x2_5 = as.numeric(x2_5),
x97_5 = as.numeric(x97_5),
time = ifelse(label == "step", "Lockdown", "Recovery"),
label = ref)
return(coef)
}
pred_val_inc <- function(data){
mod1 <- glm.nb(new_opioid_prescribing ~ time + step*label  + step2*label +
slope + slope2 + month + offset(log(opioid_naive)),
data = data, link = "log",
control = list(trace = TRUE, maxiter = 30, epsilon = 1))
pred <- predict(mod1, se.fit = TRUE)
pred2 <-
data.frame(pred_n = exp(pred$fit), lci_n = exp(pred$fit-1.96*pred$se.fit),
uci_n = exp(pred$fit+1.96*pred$se.fit), data) %>%
mutate(pred = pred_n/opioid_naive*1000, pred_lci = lci_n/opioid_naive*1000,
pred_uci = uci_n/opioid_naive*1000)
return(pred2)
}
#########################
#######################
age <- subset(combined2, group == "Age" & !(label %in% c("Missing",NA))) %>% arrange(label, date)
